name: Publish Python distribution to PyPI

on:
  push:
    branches:
      - 'main'
    paths:
      - 'likelihood/VERSION'

jobs:
  build:
    name: Build Wheels
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    env:
      PYO3_PYTHON: "${{ matrix.python-version }}"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel

      - name: Set PYO3_PYTHON
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            # Use the pythonLocation environment variable set by setup-python
            if ($env:PROCESSOR_ARCHITECTURE -eq "AMD64" -or $env:PROCESSOR_ARCHITECTURE -eq "x86_64") {
              $python_path = "C:\\hostedtoolcache\\windows\\Python\\3.10.11\\x64\\python.EXE"
            } elseif ($env:PROCESSOR_ARCHITECTURE -eq "x86") {
              $python_path = "C:\\hostedtoolcache\\windows\\Python\\3.10.11\\x86\\python.EXE"
            }
            
            # Check if pythonPath is valid
            if (-not $python_path) {
              Write-Host "ERROR: Python not found at $python_path"
              exit 1
            }

            # Set PYO3_PYTHON environment variable
            echo "PYO3_PYTHON=$python_path"
            echo "PYO3_PYTHON=$python_path" >> $env:GITHUB_ENV
          } else {
            $python_path = (which python)
            echo "PYO3_PYTHON=$python_path"
            echo "PYO3_PYTHON=$python_path" >> $env:GITHUB_ENV
          }
        shell: pwsh

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel setuptools-rust

      - name: Skip musllinux build
        run: echo "CIBW_SKIP=cp*-musllinux_*" >> $GITHUB_ENV

      - name: Build wheels with cibuildwheel
        env:
          CIBW_BEFORE_ALL: |
            curl https://sh.rustup.rs -sSf | sh -s -- -y
            rustup update stable
            if [ "$RUNNER_OS" == "Windows" ]; then
              rustup target add x86_64-pc-windows-msvc
              rustup target add i686-pc-windows-msvc
              echo "C:\\Users\\runneradmin\\.cargo\\bin" >> $GITHUB_ENV
            else
              . "$HOME/.cargo/env"
            fi
            rustc --version
          CIBW_ENVIRONMENT: "PATH=$HOME/.cargo/bin:$PATH"
          CIBW_OUTPUT_DIR: dist
          CIBW_ARCHS_WINDOWS: x86_64,i686
        run: |
          echo "Starting cibuildwheel..."
          cibuildwheel --output-dir dist

      - name: Upload all wheels into a single package
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: dist/*.whl

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"]
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
